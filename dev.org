* S7 playground
** Preparation (emsdk)
   #+BEGIN_SRC sh
cd ~/dev/github/emsdk
./emsdk install latest
./emsdk activate latest
source ./emsdk_env.sh
emcc -v
   #+END_SRC

** Building the special repl
   #+BEGIN_SRC sh
meson setup buildc
   #+END_SRC

   Building & launching
   #+BEGIN_SRC sh
ninja -C buildc
   #+END_SRC

   #+BEGIN_SRC sh
./buildc/repl
   #+END_SRC

   #+BEGIN_SRC emacs-lisp :results silent
(run-scheme (concat "buildc/repl"))
   #+END_SRC

   #+BEGIN_SRC scheme
(begin
  (display "here 1")
  (display "here 2")
  (format #t "aaa")
  (+ 1 2 3))
   #+END_SRC

** Building
   Note: =emcc= has to be in the path for the following to work

   Setting up project
   #+BEGIN_SRC sh
meson setup build --cross-file wasm.ini
   #+END_SRC

   Building & launching
   #+BEGIN_SRC sh
ninja -C build
   #+END_SRC

   #+BEGIN_SRC sh :session *emrun*
source ~/dev/github/emsdk/emsdk_env.sh
# sometimes getting Uncaught (in promise) TypeError: NetworkError when attempting to fetch resource
emrun index.html
# or (to be able to refresh - also seems more reliable?)
emrun --serve_after_close index.html
   #+END_SRC

   Useful snippets
   #+BEGIN_SRC sh
node build/s7_wasm.js
   #+END_SRC

* gh-pages
  #+BEGIN_SRC sh
git checkout --orphan gh-pages
git checkout gh-pages # or next times when the branch exists
git add index.html build/s7_wasm.js build/s7_wasm.wasm -f
git commit -am "deploy"
git push --set-upstream origin gh-pages --force
  #+END_SRC
* Dependencies
  #+BEGIN_SRC sh :session *deps*
git clone https://github.com/shaunlebron/parinfer-codemirror.git ~/dev/github/parinfer-codemirror
cd ~/dev/github/parinfer-codemirror
npm install
  #+END_SRC
* emacs-lisp etc
  The following

  #+BEGIN_SRC emacs-lisp :results silent
;; replace with an s7 repl that handles multi line input properly
(run-scheme (concat "buildc/repl"))
  #+END_SRC

  #+BEGIN_SRC sh
source ~/dev/github/emsdk/emsdk_env.sh
emrun --serve_after_close index.html
  #+END_SRC
** org-export-filter-src-block-functions
   https://orgmode.org/manual/Advanced-Export-Configuration.html
   Making the src blocks a text input + an eval button

   #+BEGIN_SRC emacs-lisp :results silent
(defun s7-playground/src-block (text backend info)
  "Exports a (scheme) src-block as a textarea coupled with an 'eval' button.
This later gets converted to a codemirror editor.
Note: the input text has already the code wrapped around some html tages which we strip ourselves"
  (let* ((code (s-trim (replace-regexp-in-string "<[^>]*>" "" text)))
	 (formatted (format "<div class='code-container'>
<textarea class='code'>%s</textarea>
<button class='eval'>eval</button>
</div>" code)))
    formatted))

;; add-to-list doesn't add if it's already there! phew!
(add-to-list 'org-export-filter-src-block-functions
	      's7-playground/src-block)
   #+END_SRC


*** Other notes
    #+BEGIN_QUOTE
   
    Oh wait! Just found org-babel-map-src-blocks and the two hooks org-export-before-{processing,parsing}-hook. That's probably what I'm going to do. â€“ purple_arrows Sep 25 '18 at 22:14

    #+END_QUOTE

** org-babel-execute:scheme
   Redefining =org-babel-execute:scheme= cause it uses geiser.. ugh!
   #+BEGIN_SRC emacs-lisp :results silent
(defun org-babel-execute:scheme (body params)
  "Execute a block of Scheme code with org-babel.
This function is called by `org-babel-execute-src-block'"

  (save-excursion
    (let* ((result-type (cdr (assq :result-type params)))
	   (session "*scheme*")
	   (full-body (org-babel-expand-body:scheme body params))
	   (comint-use-prompt-regexp nil)
	   (result
	    (progn
	      (print comint-prompt-regexp)
	      (let* ((out (print (org-babel-comint-with-output
				     ("*scheme*" "\n> " )
				   (scheme-send-string (format "(begin %s\n)" body))
				   (accept-process-output (get-buffer-process (current-buffer))))))
		     ;; #<unspecifed> etc cannot be read by emacs
		     ;; also, out is a result of split-string, so we get the car
		     (blah (print (car out)))
		     ;; fixing the #<unspecified> not being readable by emacs-lisp
		     (out (print (s-replace "#<" "<" (car out))))
		     (parsed (read out))
		     (parsed2 (mapcar (lambda (el)
					(xml-escape-string
					 ;; note: %S print string quoted
					 ;; %s removes the ".. but it's more annyoing to have it
					 (format "%s" el)
					 ))
				      parsed)))
		(concat
		 "<div class='eval-result'>\n"
		 (format "<pre class='res'>%s</pre>\n" (xml-escape-string (format "%S" (car parsed))))
		 (format "<pre class='out'>%s</pre>\n" (cadr parsed2))
		 (format "<pre class='err'>%s</pre>\n" (caddr parsed2))
		 "</div>"
		 )
		;; (print out)
		;;(s-trim (mapconcat #'identity out "\n"))
		))))
      result)))
   #+END_SRC
   
